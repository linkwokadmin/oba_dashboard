<div class="page-title-wrapper">
    <h2 class="page-title">Dashboard</h2>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default-light rounded">
            <div class="panel-heading">
                <div class="panel-title">Stream Status</div>
                <div class="panel-tools">
                    <%= simple_form_for :stream_status_filter, url: :root, method: :get, html: {class: 'form-inline'} do |f| %>
                        <%= f.input :from_date, as: :hidden, label: false, wrapper: false %>
                        <%= f.input :to_date, as: :hidden, label: false, wrapper: false %>
                        <%= f.input :stream, collection: Stream::STREAMS, selected: @stream.name || Stream::STREAM_1, include_blank: false, label: false, wrapper: false, input_html: {class: 'default-select2 input-sm rounded m-right-5'} %>
                        <div id="stream-status-daterange" class="btn btn-sm btn-default-outline rounded m-right-5">
                            <i class="fa fa-calendar m-right-5"></i>
                            <span></span>
                            <i class="fa fa-angle-down m-left-5"></i>
                        </div>
                        <%= f.submit 'Filter', class: 'btn btn-success btn-sm rounded rippler' %>
                    <% end %>
                </div>
            </div>

            <div class="panel-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Stage</th>
                        <th>Batch</th>
                        <th>On Date</th>
                        <th>Delay</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% if @stream_statuses.present? %>
                        <% @stream_statuses.each_with_index do |stream_status, index| %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= stream_status[:stage] %></td>
                                <td><%= stream_status[:batch] %></td>
                                <td><%= stream_status[:on_date] %></td>
                                <td><%= stream_status[:delay] %></td>
                            </tr>
                        <% end %>
                    <% end %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default-light rounded">
            <div class="panel-heading">
                <div class="panel-title">Stream Parameter Data</div>
                <div class="panel-tools">
                    <%= simple_form_for :reactor_attribute_filter, url: :reactor_attribute_data_dashboards, method: :post, remote: true, html: {id: 'reactor-attribute-filter-form', class: 'form-inline'} do |f| %>
                        <%= f.input :from_date, as: :hidden, label: false, wrapper: false %>
                        <%= f.input :to_date, as: :hidden, label: false, wrapper: false %>
                        <%= f.input :stream_product, collection: [], include_blank: false, label: false, wrapper: false, input_html: {id: 'stream-product-select', class: 'default-select2 input-sm rounded m-right-5'} %>
                        <%= f.input :attribute, collection: BatchLog::ATTRIBUTES, include_blank: false, label: false, wrapper: false, input_html: {class: 'default-select2 input-sm rounded m-right-5'} %>
                        <div id="reactor-attribute-daterange" class="btn btn-sm btn-default-outline rounded m-right-5">
                            <i class="fa fa-calendar m-right-5"></i>
                            <span></span>
                            <i class="fa fa-angle-down m-left-5"></i>
                        </div>
                        <%= f.submit 'Filter', class: 'btn btn-success btn-sm rounded rippler' %>
                    <% end %>
                </div>
            </div>

            <div id="canvas-holder" class="panel-body">
                <canvas id="reactor-attribute-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    setDaterange = function (date_range_picker, start, end, start_element, end_element) {
        date_range_picker.find('span').html((start.format('MMMM Do YYYY')) + " - " + (end.format('MMMM Do YYYY')));
        start_element.val(start.format('DD/MM/YYYY'));
        end_element.val(end.format('DD/MM/YYYY'));
    };

    initDateRangePicker = function (date_range_picker, start_date, end_date, start_element, end_element) {
        if (date_range_picker.length > 0) {
            start = moment(start_date);
            end = moment(end_date);
            setDaterange(date_range_picker, start, end, start_element, end_element);
            date_range_picker.daterangepicker({
                applyClass: 'btn-primary',
                opens: 'left',
                startDate: start,
                endDate: end,
                locale: {
                    format: 'MMMM Do YYYY'
                }
            }, function (start, end, label) {
                setDaterange(date_range_picker, start, end, start_element, end_element);
            });
        }
    };


    $(document).ready(function () {
        $.ajax({
            url: '<%= get_segregated_products_streams_path %>',
            method: "POST",
            dataType: "json",
        }).done(function (response) {
            $("#stream-product-select").select2({data: response});
        });

        initDateRangePicker($('#stream-status-daterange'), '<%= @from_date %>', '<%= @to_date %>', $('#stream_status_filter_from_date'), $('#stream_status_filter_to_date'));
        initDateRangePicker($('#reactor-attribute-daterange'), moment(), moment(), $('#reactor_attribute_filter_from_date'), $('#reactor_attribute_filter_to_date'));
    });

    $(document).on('ajax:success', 'form#reactor-attribute-filter-form', function (event) {
        config = {
            type: 'line',
            data: event.detail[0],
            options: {
                responsive: true,
                maintainAspectRatio: true,
                title: {
                    display: true,
                    text: 'Reactor Attribute Analysis'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Value'
                        }
                    }]
                }
            }
        };

        console.log(config);

        canvas_holder = $('#canvas-holder');
        canvas_holder.empty();
        canvas_holder.append('<canvas id="reactor-attribute-chart"></canvas>');
        new Chart($('#reactor-attribute-chart')[0].getContext('2d'), config);
    });
</script>